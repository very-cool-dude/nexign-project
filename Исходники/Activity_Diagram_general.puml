@startuml

Title: Aсtivity Diagram процесса работы системы

|CDR|
start
:Генерация звонков;
:Сохранение в БД CDR;

repeat
  :Проверка количества неотправленных звонков;
  if (≥ 10 записей?) then (да)
    :Формирование CDR-файла;
    :Отправка файла в очередь BRT;
    :Обновление is_sended = 1 (в таблице calls);
  endif
repeat while (остались неотправленные записи?) is (да)

|BRT|
:Получение CDR-файла из очереди;
if (В записи участвует абонент "Ромашка"?) then (да)
  :Поиск msisdn абонента "Ромашка" по таблице clients;
  if (msisdn ромашки справа?) then (да)
    :Поменять местами номера и тип звонка;
  endif
  :Сохранение звонка в БД BRT;
  if (is_sended = 0 в clients) then (да)
    note left
    Проверка, участвовал ли абонент ранее в тарификации
    end note
    :Формирование запроса в HRS;
    :Отправка запроса в очередь HRS;
    :Установка is_sended = 1 (в clients);
  endif
else
  :Пропуск записи;
endif

|HRS|
:Получение запроса из очереди;
:Определение тарифа и сущностей;
:Расчёт длительности и стоимости звонка;

if (parameter_value < 0?) then (да)
  :Откат тарифа на fallback с более низким приоритетом;
endif

:Формирование ответа с суммой списания/расходом минут;
:Отправка ответа в очередь BRT;

|BRT|
:Обработка ответа от HRS;
:Обновление баланса и параметров;
:is_tarifficated = 1;
note left
Указываем, что звонок протарифицирован
end note
:is_sended = 0;
note left
Абонент снова может быть тарифицирован
end note

stop
@enduml
